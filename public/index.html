<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
    <title>Jellyfisher</title>
  <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('sky', 'images/sky_bubbles.png');
    game.load.image('ground', 'images/platform.png');
    game.load.image('star', 'images/jellyfish_small.png');
    game.load.spritesheet('dude', 'images/octopus.png', 16, 15);

}

var player;
var platforms;
var cursors;
var bgtile;

var stars;
var score = 0;
var scoreText;

var xBoundLeft = 0;
var xBoundRight = 800;

var nextGroundX = 2400;
var nextJellyX = 900;

function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    game.world.setBounds(0,0, 1600, 600);

    //  A simple background for our game
    bgtile = game.add.tileSprite(0, 0, 1600, 600, 'sky');

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = game.add.group();

    //  We will enable physics for any object that is created in this group
    platforms.enableBody = true;

    // Here we create the grounds.
    var ground;
    for (var i = 0; i < 3; i++) {
        ground = platforms.create(i*800, game.world.height - 32, 'ground');

        //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
        ground.scale.setTo(2, 1);

        //  This stops it from falling away when you jump on it
        ground.body.immovable = true;
    }

    // The player and its settings
    player = game.add.sprite(32, game.world.height - 150, 'dude');
    player.scale.set(3);
    player.smoothed = false;

    //  We need to enable physics on the player
    game.physics.arcade.enable(player);

    //  Player physics properties. Give the little guy a slight bounce.
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 500;
    player.body.collideWorldBounds = true;

    //  Our two animations, walking left and right.
    player.animations.add('right', [0, 1, 2], 10, true);

    //  Finally some stars to collect
    stars = game.add.group();

    //  We will enable physics for any star that is created in this group
    stars.enableBody = true;

    //  Here we'll create 12 of them evenly spaced apart
    for (var i = 0; i < 12; i++)
    {
        //  Create a star inside of the 'stars' group
        var star = stars.create(i * 70, 0, 'star');
        star.scale.set(3);
        star.smoothed = false;

        //  Let gravity do its thing
        star.body.gravity.y = 300;

        //  This just gives each star a slightly random bounce value
        star.body.bounce.y = 0.7 + Math.random() * 0.2;
    }

    //  The score
    scoreText = game.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });

    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();

}

function update() {
    game.camera.focusOn(player);
    updatePlatforms();
    updateJellyfish();

    if (xBoundLeft < player.x-400) { xBoundLeft = player.x-400; }
    if (xBoundRight < player.x+400) { xBoundRight = player.x+400; }

    game.world.setBounds(xBoundLeft,0, xBoundRight+1600, 600);
    bgtile.width = xBoundRight;

    //  Collide the player and the stars with the platforms
    game.physics.arcade.collide(player, platforms);
    game.physics.arcade.collide(stars, platforms);

    //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
    game.physics.arcade.overlap(player, stars, collectStar, null, this);

    if (player.body.velocity.x > 0) {
        player.body.velocity.x-= 1;
    }


    if (game.input.activePointer.isDown) {
        player.body.velocity.x = 150;
        player.body.velocity.y = -250;
        player.animations.play('right');
    } else {
        player.animations.stop();
        player.frame = 0;
    }
}

function updateJellyfish() {
    var jelly;
    stars.forEachAlive(function(jelly){
        if(jelly.x < xBoundLeft-50) {
            jelly.kill();
        }
    });
    if(nextJellyX < xBoundRight+100) {
        jelly = stars.getFirstDead();
        if(jelly){
            jelly.reset(xBoundRight+50,0);
            nextJellyX = xBoundRight+200;
        }
    }

}

function updatePlatforms() {
    platforms.forEach(function(platform){
        if (platform.x < xBoundLeft-800){
            platform.kill();
            platform.reset(nextGroundX, game.world.height - 32);
            nextGroundX+=800;
        }
    });
}

function collectStar (player, star) {

    // Removes the star from the screen
    star.kill();

    //  Add and update the score
    score += 10;
    scoreText.text = 'Score: ' + score;

}

</script>

</body>
</html>
