<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
    <title>Jellyfisher</title>
  <script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });


function preload() {

    game.load.image('water', 'images/water_big.png');
    game.load.image('ground', 'images/ground.png');
    game.load.image('waves', 'images/waves.png');
    game.load.image('sky', 'images/sky_big.png');
    game.load.spritesheet('jellysmall', 'images/jellyfish_small.png', 7, 9);
    game.load.spritesheet('jellymed', 'images/jellyfish_medium.png', 9, 12);
    game.load.spritesheet('jellybig', 'images/jellyfish_big.png', 12, 16);
    game.load.spritesheet('puffers', 'images/puffer.png', 16, 14);
    game.load.spritesheet('anglers', 'images/angler.png', 16, 16);
    game.load.spritesheet('stingrays', 'images/stingray.png', 16, 6);
    game.load.spritesheet('dude', 'images/octopus.png', 15, 13);

}

var player;
var platforms;
var cursors;
var bgtile;
var skytile;
var groundtile;

var puffers;

var score = 0;
var scoreText;
var wasDown = null;

var xBoundLeft = 0;
var xBoundRight = 800;

var nextGroundX;
var nextJellyX = 900;


/*

* indicates mandatory

specs: {
    *spritesheet: 'some sheet definition', //may also be a function
    onPlayerApproach: function(member){ stuff to do to the member },
    onPlayerAway: function(member){ stuff to do to the member },
    *onAnimationSetup: function(member){ stuff around animations and initial visual state },
    prey: 'label of prey if any',
    *speed: 125, //pixels per second i suppose? only required if there are prey
    label: 'some identifier', //defaults to spritesheet which must not be a function if so
    count: 10 //defaults to 2
}
*/
var speciesManager = (function(){
    var allSpecies = [];
    var nextSpawnX = xBoundRight+200;

    var findSpeciesByLabel = function(label){
        for(var i=0; i<allSpecies.length; i++){
            if (allSpecies[i].label == label) {
                return(allSpecies[i]);
            }
        }
    }

    var destroyPrey = function(_, prey) {
        prey.kill();
    }

    var killOutOfRange = function(member){
        if(member.x < xBoundLeft-50) {
            member.kill();
        }
    }

    var spawnSpeciesIfDue = function(group){
        if (nextSpawnX < xBoundRight+50) {
            var dead = group.getFirstDead();
            if(dead) {
                dead.reset(xBoundRight-50, game.world.height - 100 - 400*Math.random());
                dead.frame = 0;
                nextSpawnX = xBoundRight+100;
            }
        }
    }

    var pursuePrey = function(predator, preys, speed) {
        game.physics.arcade.overlap(predator, preys, destroyPrey, null, this);
        var target = findNearest(predator,preys,function(prey) { return(prey.x < predator.x) });
        if (target) {
            game.physics.arcade.moveToObject(predator, target, speed);
        } else {
            predator.body.velocity.x = 0 - speed;
            predator.body.velocity.y = 0;
        }
    }

    var bounceAbout = function(member){
        if(member.body.velocity.y > 0 && member.y > 400){
            member.body.velocity.y = -150 - 50*Math.random();
            if(Math.random() >= 0.5){
                member.body.velocity.x = -80;
            } else {
                member.body.velocity.x = -30;
            }
        }
    }

    return ({
        createSpecies: function(specs) {
            var newSpecies = {
                spritesheet: specs.spritesheet,
                onPlayerApproach: specs.onPlayerApproach || function(){},
                onPlayerAway: specs.onPlayerAway || function(){},
                onAnimationSetup: specs.onAnimationSetup,
                group: game.add.group(),
                label: specs.label || specs.spritesheet,
                prey: specs.prey,
                speed: specs.speed,
                count: specs.count || 2,
                reactToPlayer: function(member){
                    if(findRectilinearDistance(player,member) < 200) {
                        newSpecies.onPlayerApproach(member);
                    } else {
                        newSpecies.onPlayerAway(member);
                    }
                }
            }
            allSpecies.push(newSpecies);
            newSpecies.group.enableBody = true;
            var member,spritesheet;
            for (var i = 0; i < newSpecies.count; i++) {
                if(typeof(newSpecies.spritesheet) == "function"){
                    spritesheet = newSpecies.spritesheet();
                } else {
                    spritesheet = newSpecies.spritesheet;
                }
                console.log(spritesheet);
                member = newSpecies.group.create(xBoundRight-100*i-50, game.world.height - 100 - 400*Math.random(), spritesheet);
                member.scale.set(3);
                member.smoothed = false;
                newSpecies.onAnimationSetup(member, spritesheet);
            }
            return (newSpecies.group);
        },
        updateAllSpecies: function() {
            var species, prey;
            for(var i = 0; i < allSpecies.length; i++) {
                species = allSpecies[i];
                prey = findSpeciesByLabel(species.prey);

                species.group.forEachAlive(killOutOfRange);
                spawnSpeciesIfDue(species.group);

                species.group.forEachAlive(function(member){
                    species.reactToPlayer(member);

                    if(prey){
                        pursuePrey(member, prey.group, species.speed);
                    } else {
                        bounceAbout(member);
                    }
                });
            }
        }
    })
})();

function create() {

    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    game.world.setBounds(0,0, 1600, 600);

    //  A simple background for our game
    bgtile = game.add.tileSprite(0, 0, 900, 600, 'water');
    bgtile.autoScroll(-120,0);

    skytile = game.add.tileSprite(0, 0, 900, 54, 'sky');

    wavetile = game.add.tileSprite(0,54,900,6, 'waves');
    wavetile.autoScroll(-150,0);

    //  The platforms group contains the ground and the 2 ledges we can jump on
    platforms = game.add.group();

    //  We will enable physics for any object that is created in this group
    platforms.enableBody = true;

    // Here we create the grounds.
    var ground;
    for (var i = 0; i < 15; i++) {
        ground = platforms.create(i*60, game.world.height - 60, 'ground');

        //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
        ground.scale.setTo(3);
        ground.smoothed = false;

        //  This stops it from falling away when you jump on it
        ground.body.immovable = true;
        nextGroundX = (i+1)*60;
    }

    // The player and its settings
    player = game.add.sprite(32, game.world.height - 150, 'dude');
    player.scale.set(3);
    player.smoothed = false;

    //  We need to enable physics on the player
    game.physics.arcade.enable(player);

    //  Player physics properties. Give the little guy a slight bounce.
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 500;
    player.body.collideWorldBounds = true;

    //  Our two animations, walking left and right.
    player.animations.add('right', [0, 1, 0, 2], 10, true);
    var mad = player.animations.add('mad', [3,4,3,4], 8, false);
    mad.onComplete.add(function(){isMad = false;},this);
    player.frame = 0;

    puffers = speciesManager.createSpecies({
        spritesheet: 'puffers',
        onAnimationSetup: function(m){
            m.frame = 0;
        },
        onPlayerApproach: function(m){
            m.frame = 1;
            m.body.velocity.x = 0;
            m.body.velocity.y = 0;
        },
        onPlayerAway: function(m){
            m.frame = 0;
        },
        prey: 'jellies',
        speed: 100,
    });

    speciesManager.createSpecies({
        spritesheet: 'anglers',
        onAnimationSetup: function(m){
            m.animations.add('cruising', [0,1], 4, true);
            m.animations.add('scared', [2,3], 4, true);
            m.animations.play('cruising');
        },
        onPlayerApproach: function(m){
            m.play('scared');
            m.body.velocity.x = 0;
            m.body.velocity.y = 0;
        },
        onPlayerAway: function(m){
            m.play('cruising');
        },
        speed: 100,
        prey: 'puffers'
    });

    speciesManager.createSpecies({
        spritesheet: 'stingrays',
        onAnimationSetup: function(m){
            m.animations.add('cruising', [0,1,0,2], 8, true);
            m.animations.play('cruising');
        },
        speed: 200,
        prey: 'anglers'
    });

    speciesManager.createSpecies({
        label: 'jellies',
        count: 10,
        spritesheet: function(){
            var picker = Math.random()*3;
            if (picker < 1) {
                return('jellysmall');
            } else if(picker < 2) {
                return('jellymed');
            } else {
                return('jellybig');
            }
        },
        onAnimationSetup: function(m,spritesheet){
            if(spritesheet == 'jellysmall') {
                m.animations.add('swim', [0, 1, 2], 10, true);
            } else {
                m.animations.add('swim', [0, 1, 2, 3, 4], 10, true);
            }
            console.log('huh?');
            //m.animations.play('swim');

            m.body.gravity.y = 150;
        },
        onPlayerApproach: function(m){
            game.physics.arcade.overlap(player, m, collectJelly, null, this);
        }
    })

    //  The score
    scoreText = game.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });
    scoreText.fixedToCamera = true;

    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();
}

var isMad = false;

function update() {
    game.camera.focusOn(player);
    updatePlatforms();
    speciesManager.updateAllSpecies();

    if (xBoundLeft < player.x-400) { xBoundLeft = player.x-400; }
    if (xBoundRight < player.x+400) { xBoundRight = player.x+400; }

    game.world.setBounds(xBoundLeft,0, xBoundRight+1600, 600);
    bgtile.width = xBoundRight;
    skytile.width = xBoundRight;
    wavetile.width = xBoundRight;

    game.physics.arcade.collide(player, platforms);

    if (player.body.velocity.x > 0) {
        player.body.velocity.x-= 1;
    }

    if (game.input.activePointer.isDown) {
        player.body.velocity.x = 150;
        player.body.velocity.y = -250;

        player.animations.play('right');
        if(!wasDown) {
            wasDown = game.time.now;
        }
    } else {
        if(wasDown+500 > game.time.now) {
            wasDown = null;
            var killed = false;
            game.physics.arcade.overlap(player, puffers, function(_,puffer){
                killed = true;
                puffer.kill();
            }, null, this);
            if(killed){
                isMad = true;
                player.animations.play('mad');
            }
        } else {
            wasDown = null;
            if(!isMad) {
                player.frame = 0;
                player.animations.stop();
            }
        }
    }
}

function updatePlatforms() {
    platforms.forEach(function(platform){
        if (platform.x < xBoundLeft-60){
            platform.kill();
            platform.reset(nextGroundX, game.world.height - 60);
            nextGroundX+=60;
        }
    });
}

function findRectilinearDistance(a,b) {
  return (Math.abs(a.x-b.x) + Math.abs(a.y-b.y));
}

function findNearest(reference,group,filter) {
  var min;
  var currDist;
  var nearest;

  group.forEachAlive(function(member){
    if(!filter || filter(member)) {
        currDist = findRectilinearDistance(member,reference);

        if(!min || currDist < min) {
          min = currDist;
          nearest = member;
        }
    }

  });

  return nearest;
}

function collectJelly (player, jelly) {

    // Removes the jelly from the screen
    jelly.kill();

    //  Add and update the score
    score += 10;
    scoreText.text = 'Score: ' + score;

}



</script>

</body>
</html>
